from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.action_chains import ActionChains
from webdriver_manager.chrome import ChromeDriverManager

def login(driver, username, password):
    driver.get("https://login.biohost.de/accounts/login/?next=/")
    WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.NAME, "username")))
    driver.find_element(By.NAME, "username").send_keys(username)
    driver.find_element(By.NAME, "password").send_keys(password)
    driver.find_element(By.XPATH, "//input[@type='submit' and @class='btn btn-primary']").click()

def navigate_to_mail_page(driver):
    WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.XPATH, "//html/body/header/div[2]/span[2]/i")))
    driver.find_element(By.XPATH, "//html/body/header/div[2]/span[2]/i").click()
    WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.XPATH, "//html/body/header/div[2]/ul/li[2]/a")))
    driver.find_element(By.XPATH, "//html/body/header/div[2]/ul/li[2]/a").click()
    driver.get("https://login.biohost.de/#ajax/mail.html")
    WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.XPATH, "//html/body/header/div[2]/span[2]/i")))
    driver.find_element(By.XPATH, "//html/body/header/div[2]/span[2]/i").click()

def sort_table_by_belegt(driver):
    WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.XPATH, "//th[@aria-label='% belegt: activate to sort column ascending']")))
    belegt_button = driver.find_element(By.XPATH, "//th[@aria-label='% belegt: activate to sort column ascending']")
    actions = ActionChains(driver)
    actions.move_to_element(belegt_button).click().perform()
    WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.XPATH, "//th[@aria-label='% belegt: activate to sort column descending']")))

def extract_table_data(driver):
    email_belegt_liste = []
    WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.XPATH, "//table[@id='dTable']")))
    table = driver.find_element(By.XPATH, "//table[@id='dTable']")
    rows = table.find_elements(By.XPATH, ".//tbody/tr")

    for row in rows:
        email = row.find_element(By.XPATH, ".//td[1]").text
        belegt = row.find_element(By.XPATH, ".//td[5]").text
        email_belegt_liste.append((email, belegt))

    return email_belegt_liste

def main():
    service = Service(ChromeDriverManager().install())
    with webdriver.Chrome(service=service) as driver:
        try:
            login(driver, "10485", "K9pLjSvfy")
            navigate_to_mail_page(driver)
            sort_table_by_belegt(driver)
            email_belegt_liste = extract_table_data(driver)

            # Liste von Tupeln ausgeben
            for item in email_belegt_liste:
                print(item)

            # Aktuelle URL ausgeben
            print(driver.current_url)

            # Browser offen lassen, um die Seite zu sehen
            input("Drücken Sie Enter, um den Browser zu schließen...")

        except Exception as e:
            print("Fehler:", e)

if __name__ == "__main__":
    main()
